services:
  - type: web
    name: fliesen-showroom
    runtime: python
    buildCommand: "pip install -r requirements.txt"
    startCommand: "gunicorn --timeout 120 --workers 1 wsgi:app"
    envVars:
      - key: GUNICORN_TIMEOUT
        value: "120"
      - key: GUNICORN_WORKERS
        value: "1"
      - key: DATABASE_URL
        sync: false
      - key: DB_SCHEMA
        sync: false
      - key: SECRET_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: fliesen-redis
          property: connectionString

  # Automatic blog generation: daily at 8:00 AM UTC (days controlled in admin)
  - type: cron
    name: blog-auto-generate
    runtime: python
    schedule: "0 8 * * *"
    buildCommand: "pip install -r requirements.txt"
    startCommand: "flask generate-blog --count 1"
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: SECRET_KEY
        sync: false

  # Publish scheduled posts: every 30 minutes
  - type: cron
    name: blog-publisher
    runtime: python
    schedule: "*/30 * * * *"
    buildCommand: "pip install -r requirements.txt"
    startCommand: "flask publish-scheduled"
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: SECRET_KEY
        sync: false

  # Automatic manufacturer sync: daily at 2:00 AM UTC
  - type: cron
    name: manufacturer-auto-sync
    runtime: python
    schedule: "0 2 * * *"
    buildCommand: "pip install -r requirements.txt"
    startCommand: "flask queue-auto-sync"
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: DB_SCHEMA
        sync: false
      - key: SECRET_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: fliesen-redis
          property: connectionString

  - type: worker
    name: manufacturer-sync-worker
    runtime: python
    buildCommand: "pip install -r requirements.txt"
    startCommand: "rq worker manufacturer-sync --url $REDIS_URL"
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: DB_SCHEMA
        sync: false
      - key: SECRET_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: fliesen-redis
          property: connectionString

  - type: redis
    name: fliesen-redis
    plan: free
    ipAllowList: []
